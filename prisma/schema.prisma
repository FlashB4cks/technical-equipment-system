// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model Area {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  gerenciaId Int?
  gerencia   Gerencia? @relation(fields: [gerenciaId], references: [id])


  equipment   Equipment[]
}

model Gerencia {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  areas     Area[]
}

model Technician {
  id        Int      @id @default(autoincrement())
  name      String
  // areaId removed as requested
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignedEquipment Equipment[] 
  maintenances      Maintenance[]

  userId    Int?     @unique
  user      User?    @relation(fields: [userId], references: [id])
}

model Equipment {
  id           Int      @id @default(autoincrement())
  type         String   
  model        String
  serialNumber String   @unique
  status       String   @default("Pending") // Pending (En espera), Diagnosing, Maintenance, Ready, Delivered
  reportedFailure String? 
  
  diagnosisFinishedAt DateTime?
  reportedBy          String?
  personInCharge      String?
  addedBy             String?

  areaId       Int?
  area         Area?    @relation(fields: [areaId], references: [id])
  
  technicianId Int?
  technician   Technician? @relation(fields: [technicianId], references: [id])

  nextMaintenanceDate DateTime?
  
  entryDate    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  maintenances Maintenance[]
  logs         EquipmentLog[]
}

model Maintenance {
  id           Int      @id @default(autoincrement())
  diagnosis    String
  resolution   String?
  observations String?
  status       String   @default("Scheduled") // Scheduled, In Progress, Completed
  date         DateTime @default(now())
  cost         Float?

  equipmentId  Int
  equipment    Equipment @relation(fields: [equipmentId], references: [id])

  technicianId Int?
  technician   Technician? @relation(fields: [technicianId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model EquipmentLog {
  id          Int      @id @default(autoincrement())
  equipmentId Int
  action      String   // e.g. "CREATED", "UPDATED", "DELETED", "STATUS_CHANGE"
  details     String
  timestamp   DateTime @default(now())
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  userName    String?
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String   @default("USER") // ADMIN, TECH
  createdAt DateTime @default(now())
  
  technician Technician?
}

model WarehouseItem {
  id          Int      @id @default(autoincrement())
  name        String
  category    String   // e.g., "Consumibles", "Repuestos", "Herramientas"
  quantity    Int      @default(0)
  minQuantity Int      @default(5) // Alert threshold
  unit        String   @default("unidades")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  movements   WarehouseMovement[]
}

model WarehouseMovement {
  id              Int      @id @default(autoincrement())
  type            String   // "IN", "OUT", "ADJUSTMENT"
  quantity        Int
  reason          String?
  
  // New Tracking Fields
  referenceDocument String? // Constancia de Salida (IN) or Oficio (OUT)
  gerencia          String? // For OUT
  subArea           String? // For OUT
  receiver          String? // Person receiving
  
  warehouseItemId Int
  warehouseItem   WarehouseItem @relation(fields: [warehouseItemId], references: [id], onDelete: Cascade)
  
  userId          String?
  date            DateTime @default(now())
}
